#include <iostream>
#include <string>
#include <cassert>
#include <cstring>
#include <vector>
#include <algorithm>

using namespace std;

const string input =
".......................#...................#....#..#......#.................#.#..#........................#.#..............#.....#\n"
"................#.#.......#..#.......#.................................................................................#.##.......\n"
"............#..............#......................#...#.....#...#..........##.........#.....#.....................................\n"
"..#...#......................................#............................#..................#..........#..#......................\n"
"....#........#.#....................#..........#.....#.............#..#............................#..................#......#....\n"
"..........................................................#................#............................................#.........\n"
"..#............................#.....#...........................#...........#........##...........................#..#...........\n"
".....................#...........................#.#..............#......................................#.........#....#.....#...\n"
".#...#.#.................#....................#...............................................................#.#..........#......\n"
"....#....................................#...........................................#.....#..........#...........................\n"
".......................#..........#..............#......#....#.......#........................................#.#.................\n"
"......#...........................................................#...#............#.................#............................\n"
".......#.................#..#.....................#...............................................................................\n"
"..............#....................#.#..........#........#......#................#.................#..........#...................\n"
"#.#.......................................#.........................#...................................#.........................\n"
"...#.........................................................................................#................#..................#\n"
"#.....#....#............................................................#.........................#..................#.#..........\n"
".#.....#.#.......#.#..................#.#......................#.......#.....#..#..................##.....#.......#...#...........\n"
"....#.........#.................................#..........#........#...............#................#...................#....#...\n"
".................#...............#...#.................#.................................................#........................\n"
"....#...#...............................#..................................................#..........#................#.....#....\n"
"...........#........#....#.......#...#..........#...............#.....#.....#.....#..........#....................................\n"
"............#.........#.................#................#.................#.#..................................................#.\n"
"............#......................................#...................................................................#..........\n"
"...........#....#.....................................................................................#............#..........#...\n"
"..........#........................................#.............#.................#........................#..#.......#........#.\n"
"......#.............................#.................##..................................#.....................#.................\n"
".#.................................#.............................................#.................##.....#..............#......#.\n"
".........................#..............................#..........#...........#....#................#......................#.....\n"
".......#...................#......##........................#.........#...........................................................\n"
"......................................................................##...........#................#.............................\n"
"....#...................................##...............................................#........................................\n"
"...##.....#..#........#.................#..............................................................#..........................\n"
"........##......#....................#..............................#......................#...................#..................\n"
".........................................................#.......................................................#.#..............\n"
"..........#.............................#.........#...............#................#.#.........#..........................#.#.....\n"
"....................#...................#..#.......................................................#..........#...............#...\n"
"...........................................................#........................#.........#........#..........................\n"
".......#..............#......#.................................#...................##...........................#.........#.......\n"
"#...#...............................................................................................................#.............\n"
"................................#..#....#............#...........#..................#.............................#...............\n"
"....................#..............#.........#.................................#.............#..##................................\n"
"#...#..................................................................................#.....#...........#........................\n"
"........#...........#........#...#..................#.....#....#.........#.........................#...........................#..\n"
".............#...#...................................................................#...........#................................\n"
".............#........................................#...#.............#..............................#..#.........#.............\n"
"...#.................................................................................#.............#..........................##..\n"
"...#..............................................................................................................................\n"
"................#.........#..................................#...................#................................................\n"
"...#................#...#.#.....................#...........#..................................#........#....#......#.............\n"
"..........................#.....................#..#...................................##........................................#\n"
"#........................#...............................................#........#..#..........#...........................#.....\n"
".#............#.#..............................................................#...........#......................................\n"
"......#..................................................................#.......#..............................#...#....#........\n"
"........#........................#.........#.............#.....#..................................................................\n"
"...............................................................................#...........................................#......\n"
"........................#..................................#.....................................................#................\n"
"............................................................#..........................#.................#.......................#\n"
".....................#..#.........................#..............#.............................#........#..............##......#..\n"
".....................#.................................................#.......#............#........................#.......#....\n"
"......................#.....................................................#......#............................#.................\n"
"................................................................#...#..##..#.....................................#...............#\n"
"..............#..............................................................................................#....................\n"
"............................................#......#..........#...............................................................#...\n"
"....#.................................#..................................................................#..........##..#.........\n"
"............#.....#................................................................................#..........#.........#.........\n"
".....................#......................................#.........#....................................................#....#.\n"
".........................#...............................#...............................#....................#...................\n"
".#.....................#.#.......................................#....#...........#.......................#.......................\n"
".....................................................#.#..#......................................................................#\n"
"#..........#..........................#............................#.............#..................#.............#...........#...\n"
"........#.........................................................................................................................\n"
"..........#.............#.........................................#................................................#..............\n"
"...........#................................#.................#...........................#.............................#.........\n"
"..................#.........................................#.#..................#...#...........#.......#..#.....................\n"
"........................................................#...#.......................................................#.............\n"
".........................................................................#.......#..#.....#.......................................\n"
"............#..............................................................#.........#..............#.............#...............\n"
"#...#..........................................#...........#.....#.....................................#...............#..........\n"
"...........................#............#.........................................................................................\n"
"...#..........................................#.......................................................................#...........\n"
"..............#......#.....#.....................#..........................#.....................................................\n"
".........................#....#...................#...#.......#..............................#........................#...........\n"
".............................#............^.#................................................#......#..#.#...........#............\n"
"....................................................................................#...#.#...................................#...\n"
".......................#..............................##..............................................#...........................\n"
"......................#...................................................#..........................................#............\n"
"......#........................................................................#.....................................#............\n"
".......................#.............................#........................#...........#...........#............#...........#..\n"
"....#...............#..#......#....#..................#.............#.......#...............#.......................#.............\n"
"............#...#..................#..............................................................................................\n"
"....#.......#.................#.......................................................#..#......#.................................\n"
".........#......#..........#......................#.....................#..................#.#....................................\n"
"...............##.......................................................#...#.............................#.......#...............\n"
"........................................................##...................#...#............#......#............................\n"
"...........#...#..............#.............................................................#...................#............#....\n"
"...............................................#.....#.....#......................................................................\n"
".#....................#...#........#....................#.#.........#..........#................................#................#\n"
".............#.....#..#....................................#.#...........#.................................................#..#.#.\n"
"......#.....................................#....................................................................#................\n"
"............................................................##......#.....................#.......#.....................#...#.....\n"
".#.......#......................#.................................................................................................\n"
"................#....#......................#.........#...................#........#.......##.....#...............................\n"
"..#....#....................#............................................................#.#......#............#.....#.#....#.....\n"
".................................#.................................................#.......#......................................\n"
"..................#...........#....#.....................#......#...............#..................#....................##........\n"
".##...............................................#............#...........................#......................................\n"
".............#...........#...........................#..#.......#...#..........#......................#..........#................\n"
".......#...................................#.................#....#..............................................................#\n"
"........#....................................................#.................#.....#.........#.#................................\n"
"................#.................................#.....................#.....#.....#............................##...............\n"
"..............................................##.................#..##........#...........#............#..........................\n"
"....#......................................#...............................................................................#......\n"
"..#..............#.#................#..#..............#.......................................#.#.......#..............#......#..#\n"
".....#..............................................................................................................#.......#.....\n"
"..#.......#.#..........#.......#..................................#..........#.......#.................#...........#...........#..\n"
"...............#.....#................#............#................#............#.....#.#........#...............................\n"
"....#.....................#................#.....................................#......................#.#.......#....#..........\n"
"........#...............#...#.....................................................#........#.........#.........#..................\n"
"...#......#..........................#.....#..........................##.......#....#.............................................\n"
".............#................................#............................#.....#.......#......#................................#\n"
".......................#............#..........................#..................................................................\n"
".................................................#..............#...#...........................#.................................\n"
"......#...................#..............................................................................................#....#..#\n"
"....................................#......#.....................#..............#.......#...................#.....................\n"
"............#...................................#...........#........#........#...........................................##......\n"
"#...........#..........................#....................................#.........#................................#..........\n"
"......##..#...............................................................#...............................#.........#.............\n"
".......................#.....#.........................#...#.........................#.....#..........#.#...#.....................\n"
".......................#..#.....#.....#..........................#.........#.....#....................#.....#....................#\n";

char GUARD = '^';
char BLOCK = '#';
char EMPTY = '.';
char PATH = 'X';
char U = 'U';
char D = 'D';
char R = 'R';
char L = 'L';
unsigned int N_DIRS = 4;
char dirs[] = {U, R, D, L};
int X = -1;
int Y = -1;
int px1 = -1;
int px2 = -1;
int py1 = -1;
int py2 = -1;

const int MX = 130;
const int MY = 130;

void set(char *m, int x, int y, char c)
{
    m[x+MX*y] = c;
}

char get(const char *m, int x, int y)
{
    return m[x+MX*y];
}

void parse_input(const string &input, int *gx, int *gy, char *gd, char *m)
{
    for (int x=0; x<MX; ++x)
        for (int y=0; y<MY; ++y)
            set(m, x, y, EMPTY);
    int y = 0;
    size_t pos = 0;
    string s = input;
    string line;
    while ((pos = s.find("\n")) != string::npos) {
        line = s.substr(0, pos);
        int x = 0;
        for (char &c: line) {
            set(m, x, y, c);
            if (c == GUARD) {
                *gx = x;
                *gy = y;
                *gd = U;
                set(m, x, y, EMPTY);
            }
            x += 1;
        }
        X = x;
        y += 1;
        s.erase(0, pos+1);
    }
    Y = y;
}

void move(int *gx, int *gy, char *gd, char *m)
{
    int dx, dy;
    if (*gd == U)
        dx = 0, dy = -1;
    else if (*gd == R)
        dx = 1, dy = 0;
    else if (*gd == D)
        dx = 0, dy = 1;
    else if (*gd == L)
        dx = -1, dy = 0;
    else
        assert(false);
    int ngx = *gx + dx;
    int ngy = *gy + dy;
    if (ngx < 0 || ngx >= X || ngy < 0 || ngy >= Y || get(m, *gx+dx, *gy+dy) != BLOCK) {
        *gx = ngx;
        *gy = ngy;
    } else
        for (int i=0; i<N_DIRS; ++i)
            if (dirs[i] == *gd) {
                *gd = dirs[(i+1)%N_DIRS];
                break;
            }
}

bool visited(const vector<string>& path, int gx, int gy, char gd)
{
    const string s = to_string(gx+MX*gy) + gd;
    return (std::find(path.begin(), path.end(), s) != path.end());
}

void append(vector<string>& path, int gx, int gy, char gd)
{
    const string s = to_string(gx+MX*gy) + gd;
    path.push_back(s);
}

bool is_loop(int gx, int gy, char gd, int x, int y, const char *m)
{
    char tm[MX*MY];
    strncpy(tm, m, MX*MY);
    set(tm, x, y, BLOCK);
    bool inside = true;
    vector<string> path;
    while (inside) {
        if (visited(path, gx, gy, gd))
            return true;
        append(path, gx, gy, gd);
        if (0<=gx && gx<X && 0<=gy && gy<Y) {
            if (get(tm, gx, gy) == EMPTY)
                set(tm, gx, gy, PATH);
            assert(get(tm, gx, gy) == PATH);
            move(&gx, &gy, &gd, tm);
        } else
            inside = false;
    }
    return false;
}

const string solve_1(const string& input)
{
    int gx, gy;
    char gd;
    char m[MX*MY];
    parse_input(input, &gx, &gy, &gd, m);
    int n = 0;
    bool inside = true;
    while (inside) {
        if (0<=gx && gx<X && 0<=gy && gy<Y) {
            if (get(m, gx, gy) == EMPTY) {
                set(m, gx, gy, PATH);
                n += 1;
            }
            assert(get(m, gx, gy) == PATH);
            move(&gx, &gy, &gd, m);
        } else
            inside = false;
    }
    return to_string(n);
}

const string solve_2(const string& input)
{
    int gx, gy;
    char gd;
    char m[MX*MY];
    parse_input(input, &gx, &gy, &gd, m);
    int n = 0;
    for (int x=0; x<X; ++x)
        for (int y=0; y<X; ++y) {
            if (get(m, x, y) == BLOCK || (x == gx && y == gy))
                continue;
            cout << x << "," << y << "\n";
            if (is_loop(gx, gy, gd, x, y, m)) {
                cout << "Loop\n";
                n += 1;
            }
        }
    return to_string(n);
}

int main(int argc, char *argv[])
{
    cout << "===== AoC-2024 day #6 =====\n\n";

    string s =
"....#.....\n"
".........#\n"
"..........\n"
"..#.......\n"
".......#..\n"
"..........\n"
".#..^.....\n"
"........#.\n"
"#.........\n"
"......#...\n";
    assert(solve_1(s) == "41");
    assert(solve_2(s) == "6");

    cout << "Answer 1: " << solve_1(input) << "\n";
    cout << "Answer 2: " << solve_2(input) << "\n";
    return 0;
}
